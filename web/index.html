<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Commander Deck Picker</title>
<style>
/* Minimal styling; reuse your existing styles if desired */
body { font-family: sans-serif; background: #1e1b4b; color: white; padding: 2rem; }
.container { max-width: 800px; margin: auto; }
h1 { text-align: center; margin-bottom: 1rem; }
select, button { padding: 0.5rem 1rem; margin: 0.5rem 0; }
.bracket-grid { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
.bracket-btn { flex: 1 0 100px; cursor: pointer; border-radius: 0.5rem; border: none; background: #4f46e5; color: white; font-weight: bold; }
.result-card { margin-top: 2rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 0.5rem; }
</style>
</head>
<body>
<div class="container">
<h1>Commander Deck Picker</h1>

<!-- Player Selection -->
<label>Choose Player:</label>
<select id="playerSelect">
  <option value="">-- Select a Player --</option>
  <option value="catar">Tilman</option>
  <option value="timmsen">Tim</option>
  <option value="failbob">Tobi</option>
</select>

<!-- Loading & Error -->
<div id="loading" class="hidden">Loading decks...</div>
<div id="error" class="hidden" style="color: #f87171;"></div>

<!-- Bracket Buttons -->
<div id="bracketGrid" class="bracket-grid hidden"></div>

<!-- Result -->
<div id="result"></div>
</div>

<script>
// =========================
// Configuration
// =========================
const proxyUrl = 'https://deck-proxy.onrender.com/api/decks/'; // <- Replace with your proxy URL

const playerDeckIds = {
  catar: [17452615, 12724013, 12721698, 4834917, 16157808, 12721818, 12723622, 12724320, 12721529, 12877086, 12724082, 12721904, 12723944, 12724426, 12724382, 12723766, 12722429, 12722626, 12723709, 12722171, 12721379, 12722317, 12721767],
  timmsen: [15823364, 7217237, 7630552, 13137118, 9306087, 4897549, 15500438, 12846990, 10956256],
  failbob: [17685060, 14797112, 14805167, 17580409, 13194956]
};

// =========================
// State
// =========================
let currentDecks = [];
let decksByBracket = {};

// =========================
// DOM Elements
// =========================
const playerSelect = document.getElementById('playerSelect');
const loadingDiv = document.getElementById('loading');
const errorDiv = document.getElementById('error');
const bracketGrid = document.getElementById('bracketGrid');
const resultDiv = document.getElementById('result');

// =========================
// Event Listeners
// =========================
playerSelect.addEventListener('change', handlePlayerSelection);

// =========================
// Functions
// =========================

async function handlePlayerSelection() {
  const username = playerSelect.value;
  resetUI();
  if (!username) return;
  await loadPlayerDecks(username);
}

async function loadPlayerDecks(username) {
  showLoading();
  hideError();

  try {
    const deckIds = playerDeckIds[username];
    if (!deckIds || deckIds.length === 0) throw new Error('No decks found for this player');

    const deckPromises = deckIds.map(id => fetchDeckViaProxy(id));
    const decks = await Promise.all(deckPromises);

    currentDecks = decks.filter(deck => deck !== null);
    if (currentDecks.length === 0) throw new Error('Failed to load any decks.');

    organizeDecksByBracket();
    renderBrackets();
    hideLoading();
  } catch (err) {
    hideLoading();
    showError(err.message);
    console.error(err);
  }
}

async function fetchDeckViaProxy(deckId) {
  try {
    const res = await fetch(`${proxyUrl}${deckId}`);
    if (!res.ok) throw new Error(`Failed to fetch deck ${deckId}`);
    const data = await res.json();
    return {
      id: data.id,
      name: data.name,
      bracket: data.edhBracket ?? 'Unknown',
      url: `https://archidekt.com/decks/${data.id}`
    };
  } catch (err) {
    console.warn(err);
    return null;
  }
}

function organizeDecksByBracket() {
  decksByBracket = {};
  currentDecks.forEach(deck => {
    const bracket = deck.bracket;
    if (!decksByBracket[bracket]) decksByBracket[bracket] = [];
    decksByBracket[bracket].push(deck);
  });
}

function renderBrackets() {
  bracketGrid.innerHTML = '';
  bracketGrid.classList.remove('hidden');

  Object.keys(decksByBracket).sort((a, b) => a - b).forEach(bracket => {
    const btn = document.createElement('button');
    btn.className = 'bracket-btn';
    btn.textContent = `Bracket ${bracket} (${decksByBracket[bracket].length})`;
    btn.addEventListener('click', () => selectRandomDeck(bracket));
    bracketGrid.appendChild(btn);
  });
}

function selectRandomDeck(bracket) {
  const decks = decksByBracket[bracket];
  if (!decks || decks.length === 0) {
    showError('No decks available in this bracket');
    return;
  }
  const deck = decks[Math.floor(Math.random() * decks.length)];
  displayDeck(deck);
}

function displayDeck(deck) {
  resultDiv.innerHTML = `
    <div class="result-card">
      <h2>${deck.name}</h2>
      <p>Bracket: ${deck.bracket}</p>
      <a href="${deck.url}" target="_blank">View on Archidekt â†’</a>
    </div>
  `;
}

// =========================
// UI Helpers
// =========================
function resetUI() {
  currentDecks = [];
  decksByBracket = {};
  bracketGrid.innerHTML = '';
  bracketGrid.classList.add('hidden');
  resultDiv.innerHTML = '';
  hideError();
}

function showLoading() { loadingDiv.classList.remove('hidden'); }
function hideLoading() { loadingDiv.classList.add('hidden'); }
function showError(msg) { errorDiv.textContent = msg; errorDiv.classList.remove('hidden'); }
function hideError() { errorDiv.classList.add('hidden'); }

</script>
</body>
</html>
